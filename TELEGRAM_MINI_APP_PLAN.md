# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram Mini App –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram

## üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ–¥—Ö–æ–¥: –ì–∏–±—Ä–∏–¥–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (Best Practice)

### –ü–æ—á–µ–º—É –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥?

1. **–ï–¥–∏–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –≤–µ–∑–¥–µ** ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å –≤ Mini App, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –Ω–∞ —Å–∞–π—Ç–µ
2. **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—É –ø—Ä–æ–µ–∫—Ç–∞** ‚Äî —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å OAuth (VK, Yandex) —Å –ø—Ä–∏–≤—è–∑–∫–æ–π/–æ—Ç–≤—è–∑–∫–æ–π
3. **–õ—É—á—à–∏–π UX** ‚Äî –º–µ–Ω—å—à–µ –±–∞—Ä—å–µ—Ä–æ–≤ –¥–ª—è –≤—Ö–æ–¥–∞
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** ‚Äî –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ —Å–ø–æ—Å–æ–±—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

---

## üìã –≠—Ç–∞–ø—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –°–æ–∑–¥–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram-–±–æ—Ç–∞

#### 1.1. –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather

1. –û—Ç–∫—Ä—ã—Ç—å Telegram –∏ –Ω–∞–π—Ç–∏ `@BotFather`
2. –í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É `/newbot`
3. –£–∫–∞–∑–∞—Ç—å –∏–º—è –±–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "PrimeFoods")
4. –£–∫–∞–∑–∞—Ç—å username (–Ω–∞–ø—Ä–∏–º–µ—Ä: `@PrimeFoodsBot`)
5. **–°–æ—Ö—Ä–∞–Ω–∏—Ç—å Bot Token** ‚Äî –æ–Ω –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–ª—è `.env`

#### 1.2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Mini App

1. –í `@BotFather` –≤—ã–ø–æ–ª–Ω–∏—Ç—å `/mybots`
2. –í—ã–±—Ä–∞—Ç—å —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –±–æ—Ç–∞
3. –ü–µ—Ä–µ–π—Ç–∏ –≤ "Bot Settings" ‚Üí "Menu Button"
4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "Open App" —Å URL –≤–∞—à–µ–≥–æ Mini App:
   ```
   https://primefoods.ru/tg-app
   ```
   (–∏–ª–∏ `https://tma.primefoods.ru` –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø–æ–¥–¥–æ–º–µ–Ω–∞)

#### 1.3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–í `@BotFather` –≤—ã–ø–æ–ª–Ω–∏—Ç—å `/setcommands` –¥–ª—è –≤–∞—à–µ–≥–æ –±–æ—Ç–∞:

```
start - –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
help - –ü–æ–º–æ—â—å
orders - –ú–æ–∏ –∑–∞–∫–∞–∑—ã
```

#### 1.4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í `laravel/.env` –¥–æ–±–∞–≤–∏—Ç—å:

```env
# Telegram Bot
TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz
TELEGRAM_BOT_NAME=PrimeFoodsBot
TELEGRAM_WEBAPP_URL=https://primefoods.ru/tg-app

# –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok –∏–ª–∏ Cloudflare Tunnel
# –ü—Ä–∏–º–µ—Ä —Å ngrok: https://abc123.ngrok-free.app/tg-app
TELEGRAM_WEBAPP_URL_DEV=https://your-ngrok-url.ngrok-free.app/tg-app

# –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Bot Token)
# TELEGRAM_BOT_TOKEN —É–∂–µ —É–∫–∞–∑–∞–Ω –≤—ã—à–µ
```

**‚ö†Ô∏è –í–ê–ñ–ù–û:** Telegram Bot **–ù–ï –ø—Ä–∏–Ω–∏–º–∞–µ—Ç** `localhost` URLs. –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω—É–∂–µ–Ω –ø—É–±–ª–∏—á–Ω—ã–π HTTPS —Ç—É–Ω–Ω–µ–ª—å (ngrok, Cloudflare Tunnel –∏ —Ç.–¥.).

–í `config/services.php` –¥–æ–±–∞–≤–∏—Ç—å:

```php
'telegram' => [
    'bot_token' => env('TELEGRAM_BOT_TOKEN'),
    'bot_name' => env('TELEGRAM_BOT_NAME'),
    'webapp_url' => env('TELEGRAM_WEBAPP_URL'),
    'webapp_url_dev' => env('TELEGRAM_WEBAPP_URL_DEV'),
],
```

---

### –≠—Ç–∞–ø 2: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ User

#### 2.1. –ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π Telegram

–°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é: `laravel/app/Modules/User/database/migrations/YYYY_MM_DD_HHMMSS_add_telegram_fields_to_users_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::table('users', function (Blueprint $table) {
            $table->bigInteger('telegram_id')->nullable()->unique()->after('yandex_id');
            $table->string('telegram_username', 100)->nullable()->after('telegram_id');
            $table->string('telegram_first_name', 100)->nullable()->after('telegram_username');
            $table->string('telegram_last_name', 100)->nullable()->after('telegram_first_name');
            $table->string('telegram_photo_url')->nullable()->after('telegram_last_name');
        });
    }

    public function down(): void
    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropColumn([
                'telegram_id',
                'telegram_username',
                'telegram_first_name',
                'telegram_last_name',
                'telegram_photo_url',
            ]);
        });
    }
};
```

#### 2.2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ User

–í `laravel/app/Modules/User/src/Models/User.php`:

```php
protected $fillable = [
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
    'telegram_id',
    'telegram_username',
    'telegram_first_name',
    'telegram_last_name',
    'telegram_photo_url',
];

// –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏–≤—è–∑–∫–∏ Telegram
public function hasTelegram(): bool
{
    return !empty($this->telegram_id);
}
```

---

### –≠—Ç–∞–ø 3: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ Telegram (Backend)

#### 3.1. –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ Telegram –¥–∞–Ω–Ω—ã—Ö

–°–æ–∑–¥–∞—Ç—å: `laravel/app/Modules/Authorization/src/Services/TelegramAuthService.php`

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:**
- Telegram –ø–µ—Ä–µ–¥–∞—ë—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `initData` (query string)
- –ü–∞—Ä–∞–º–µ—Ç—Ä `hash` —Å–æ–¥–µ—Ä–∂–∏—Ç HMAC-SHA256 –ø–æ–¥–ø–∏—Å—å
- **–í–°–ï–ì–î–ê –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ** ‚Äî –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–æ–≤–µ—Ä—è–µ–º –∫–ª–∏–µ–Ω—Ç—É

**–ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ–≤–µ—Ä–∫–∏:**
1. –ü–æ–ª—É—á–∏—Ç—å `initData` –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
2. –†–∞–∑–æ–±—Ä–∞—Ç—å query string –Ω–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
3. –ò–∑–≤–ª–µ—á—å `hash` (—ç—Ç–æ –ø–æ–¥–ø–∏—Å—å)
4. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å `data_check_string` –∏–∑ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–≤ –∞–ª—Ñ–∞–≤–∏—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ)
5. –í—ã—á–∏—Å–ª–∏—Ç—å `secret_key = HMAC_SHA256("WebAppData", BOT_TOKEN)`
6. –í—ã—á–∏—Å–ª–∏—Ç—å `hmac = HMAC_SHA256(data_check_string, secret_key)`
7. –°—Ä–∞–≤–Ω–∏—Ç—å `hmac` —Å `hash`
8. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `auth_date` (–Ω–µ —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤)

#### 3.2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞

```php
<?php

namespace Authorization\Services;

use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Crypt;

class TelegramAuthService
{
    /**
     * –í–∞–ª–∏–¥–∞—Ü–∏—è initData –æ—Ç Telegram WebApp
     * 
     * @param string $initData Query string –æ—Ç Telegram.WebApp.initData
     * @return array|false –ú–∞—Å—Å–∏–≤ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ false –ø—Ä–∏ –æ—à–∏–±–∫–µ
     */
    public static function validateInitData(string $initData): array|false
    {
        try {
            // –†–∞–∑–±–∏—Ä–∞–µ–º query string
            parse_str($initData, $data);
            
            if (!isset($data['hash'])) {
                Log::warning('Telegram auth: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç hash –≤ initData');
                return false;
            }
            
            $hash = $data['hash'];
            unset($data['hash']);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º auth_date (–Ω–µ —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤)
            if (isset($data['auth_date'])) {
                $authDate = (int) $data['auth_date'];
                $currentTime = time();
                if ($currentTime - $authDate > 86400) { // 24 —á–∞—Å–∞
                    Log::warning('Telegram auth: –∏—Å—Ç—ë–∫ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è auth_date', [
                        'auth_date' => $authDate,
                        'current_time' => $currentTime,
                    ]);
                    return false;
                }
            }
            
            // –°—Ç—Ä–æ–∏–º data_check_string
            ksort($data);
            $dataCheckString = [];
            foreach ($data as $key => $value) {
                $dataCheckString[] = "{$key}={$value}";
            }
            $dataCheckString = implode("\n", $dataCheckString);
            
            // –í—ã—á–∏—Å–ª—è–µ–º secret_key
            $botToken = config('services.telegram.bot_token');
            $secretKey = hash_hmac('sha256', 'WebAppData', $botToken, true);
            
            // –í—ã—á–∏—Å–ª—è–µ–º HMAC
            $calculatedHash = bin2hex(
                hash_hmac('sha256', $dataCheckString, $secretKey, true)
            );
            
            // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ö–µ—à–∏ (timing-safe comparison)
            if (!hash_equals($calculatedHash, $hash)) {
                Log::warning('Telegram auth: –Ω–µ–≤–µ—Ä–Ω–∞—è –ø–æ–¥–ø–∏—Å—å', [
                    'calculated' => $calculatedHash,
                    'received' => $hash,
                ]);
                return false;
            }
            
            // –ü–∞—Ä—Å–∏–º user –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
            $userData = [];
            if (isset($data['user'])) {
                $userData = json_decode($data['user'], true);
            }
            
            return [
                'user' => $userData,
                'auth_date' => $data['auth_date'] ?? null,
                'query_id' => $data['query_id'] ?? null,
                'start_param' => $data['start_param'] ?? null,
            ];
            
        } catch (\Exception $e) {
            Log::error('Telegram auth: –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
            ]);
            return false;
        }
    }
}
```

---

### –≠—Ç–∞–ø 4: –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram

#### 4.1. –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞

–°–æ–∑–¥–∞—Ç—å: `laravel/app/Modules/Authorization/src/Http/Controllers/TelegramAuthController.php`

**–õ–æ–≥–∏–∫–∞ (–ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å VkontakteController):**

1. **–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω** ‚Üí –ø—Ä–∏–≤—è–∑–∫–∞ Telegram –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –∞–∫–∫–∞—É–Ω—Ç—É
2. **–ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:**
   - –ò—â–µ–º –ø–æ `telegram_id`
   - –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Üí –∏—â–µ–º –ø–æ `phone` (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ –¥–∞–Ω–Ω—ã—Ö Telegram)
   - –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Üí —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ `Auth::login()`
4. –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ —á–µ—Ä–µ–∑ `ActivityLogService`

```php
<?php

namespace Authorization\Http\Controllers;

use App\Http\Controllers\Controller;
use App\Models\UserActivityLog;
use App\Services\ActivityLogService;
use App\Support\UserBlockHelper;
use Authorization\Services\TelegramAuthService;
use Carbon\Carbon;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Log;
use Referral\Models\Referral;
use User\Models\User;

class TelegramAuthController extends Controller
{
    public function webappAuth(Request $request, ActivityLogService $activityLogService): JsonResponse
    {
        $request->validate([
            'initData' => 'required|string',
        ]);
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ Telegram
        $telegramData = TelegramAuthService::validateInitData($request->initData);
        
        if (!$telegramData) {
            $activityLogService->logSocialAuth(null, $request, UserActivityLog::PROVIDER_TELEGRAM, false);
            return response()->json([
                'success' => false,
                'error' => '–ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ–¥–ø–∏—Å—å Telegram –¥–∞–Ω–Ω—ã—Ö',
            ], 401);
        }
        
        $userInfo = $telegramData['user'] ?? null;
        
        if (!$userInfo || !isset($userInfo['id'])) {
            return response()->json([
                'success' => false,
                'error' => '–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã',
            ], 400);
        }
        
        $telegramId = (string) $userInfo['id'];
        $telegramUsername = $userInfo['username'] ?? null;
        $telegramFirstName = $userInfo['first_name'] ?? null;
        $telegramLastName = $userInfo['last_name'] ?? null;
        $telegramPhotoUrl = $userInfo['photo_url'] ?? null;
        
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Üí –ø—Ä–∏–≤—è–∑–∫–∞
        if (Auth::check()) {
            $user = Auth::user();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ—Ç Telegram ID –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            $telegramExists = User::where('telegram_id', $telegramId)
                ->where('id', '!=', $user->id)
                ->exists();
            
            if ($telegramExists) {
                return response()->json([
                    'success' => false,
                    'error' => '–≠—Ç–æ—Ç Telegram –∞–∫–∫–∞—É–Ω—Ç —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é',
                ], 409);
            }
            
            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º Telegram
            $user->update([
                'telegram_id' => $telegramId,
                'telegram_username' => $telegramUsername,
                'telegram_first_name' => $telegramFirstName,
                'telegram_last_name' => $telegramLastName,
                'telegram_photo_url' => $telegramPhotoUrl,
            ]);
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–º—è, –µ—Å–ª–∏ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ
            if (empty($user->name) && $telegramFirstName) {
                $user->update(['name' => $telegramFirstName]);
            }
            if (empty($user->last_name) && $telegramLastName) {
                $user->update(['last_name' => $telegramLastName]);
            }
            
            return response()->json([
                'success' => true,
                'linked' => true,
                'user' => $user->only(['id', 'name', 'email', 'phone']),
            ]);
        }
        
        // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ telegram_id
        $user = User::where('telegram_id', $telegramId)->first();
        
        // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –∏—â–µ–º –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ Telegram)
        if (!$user && isset($userInfo['phone_number'])) {
            $phone = \App\Helpers\PhoneHelper::formatPhone($userInfo['phone_number']);
            $user = User::where('phone', $phone)->first();
            
            if ($user) {
                // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º Telegram –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –∞–∫–∫–∞—É–Ω—Ç—É
                $user->update([
                    'telegram_id' => $telegramId,
                    'telegram_username' => $telegramUsername,
                    'telegram_first_name' => $telegramFirstName,
                    'telegram_last_name' => $telegramLastName,
                    'telegram_photo_url' => $telegramPhotoUrl,
                ]);
            }
        }
        
        // –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –Ω–µ –Ω–∞—à–ª–∏ ‚Üí —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        $isNewUser = false;
        if (!$user) {
            $isNewUser = true;
            $user = User::create([
                'name' => $telegramFirstName,
                'last_name' => $telegramLastName,
                'telegram_id' => $telegramId,
                'telegram_username' => $telegramUsername,
                'telegram_first_name' => $telegramFirstName,
                'telegram_last_name' => $telegramLastName,
                'telegram_photo_url' => $telegramPhotoUrl,
                'phone' => isset($userInfo['phone_number']) 
                    ? \App\Helpers\PhoneHelper::formatPhone($userInfo['phone_number']) 
                    : null,
                'phone_verified_at' => isset($userInfo['phone_number']) ? Carbon::now() : null,
                'password' => null,
            ]);
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if ($referralCode = session('referral_code')) {
                $referral = Referral::where('referral_code', $referralCode)
                    ->whereNull('invited_id')
                    ->first();
                
                if ($referral && $referral->inviter_id !== $user->id) {
                    $alreadyInvited = Referral::where('invited_id', $user->id)->exists();
                    if (!$alreadyInvited) {
                        $referral->update(['invited_id' => $user->id]);
                    }
                }
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        if (UserBlockHelper::isBlocked($user)) {
            $activityLogService->logSocialAuth($user, $request, UserActivityLog::PROVIDER_TELEGRAM, false);
            
            Log::warning('Telegram auth: –ø–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', [
                'user_id' => $user->id,
                'telegram_id' => $telegramId,
            ]);
            
            return response()->json([
                'success' => false,
                'errors' => [
                    'blocked' => UserBlockHelper::blockMessage(),
                ],
            ], 403);
        }
        
        // –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        Auth::login($user);
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        $activityLogService->logSocialAuth(
            $user, 
            $request, 
            UserActivityLog::PROVIDER_TELEGRAM, 
            true, 
            $isNewUser
        );
        
        return response()->json([
            'success' => true,
            'registered' => $isNewUser,
            'user' => $user->only(['id', 'name', 'email', 'phone']),
        ]);
    }
    
    /**
     * –û—Ç–≤—è–∑–∫–∞ Telegram –∞–∫–∫–∞—É–Ω—Ç–∞
     */
    public function detach(): JsonResponse
    {
        $user = Auth::user();
        
        if (!$user->telegram_id) {
            return response()->json([
                'success' => false,
                'error' => 'Telegram –∞–∫–∫–∞—É–Ω—Ç –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω',
            ], 400);
        }
        
        $user->update([
            'telegram_id' => null,
            'telegram_username' => null,
            'telegram_first_name' => null,
            'telegram_last_name' => null,
            'telegram_photo_url' => null,
        ]);
        
        return response()->json([
            'success' => true,
            'message' => 'Telegram –∞–∫–∫–∞—É–Ω—Ç –æ—Ç–≤—è–∑–∞–Ω',
        ]);
    }
}
```

#### 4.2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–æ—É—Ç–æ–≤

–í `laravel/app/Modules/Authorization/routes/auth.php`:

```php
// Telegram Mini App –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
Route::post('telegram/webapp-auth', [TelegramAuthController::class, 'webappAuth'])
    ->name('telegram.webapp.auth');

// –û—Ç–≤—è–∑–∫–∞ Telegram (—Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
Route::middleware('auth')->group(function () {
    Route::post('telegram/detach', [TelegramAuthController::class, 'detach'])
        ->name('telegram.detach');
});
```

---

### –≠—Ç–∞–ø 5: Frontend ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Telegram WebApp

#### 5.1. –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ä–æ—É—Ç–∞ –¥–ª—è Mini App

–í `laravel/resources/js/app.js` –∏–ª–∏ –≤ —Ä–æ—É—Ç–∏–Ω–≥–µ Inertia –¥–æ–±–∞–≤–∏—Ç—å:

```javascript
// Telegram Mini App route
{
    path: '/tg-app',
    name: 'telegram-app',
    component: () => import('./pages/TelegramApp.vue'),
    meta: {
        requiresAuth: false, // –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram
    },
}
```

#### 5.2. –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ TelegramApp.vue

–°–æ–∑–¥–∞—Ç—å: `laravel/resources/js/pages/TelegramApp.vue`

```vue
<template>
    <div class="telegram-app">
        <div v-if="loading" class="loading">
            –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...
        </div>
        
        <div v-else-if="error" class="error">
            {{ error }}
        </div>
        
        <div v-else>
            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç Mini App -->
            <router-view />
        </div>
    </div>
</template>

<script setup>
import { onMounted, ref } from 'vue';
import { useRouter } from 'vue-router';
import axios from 'axios';

const loading = ref(true);
const error = ref(null);
const router = useRouter();

onMounted(async () => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ Telegram WebApp
    if (!window.Telegram?.WebApp) {
        error.value = '–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ Telegram';
        loading.value = false;
        return;
    }
    
    const tg = window.Telegram.WebApp;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    tg.ready();
    tg.expand(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    tg.setHeaderColor('#ffffff');
    tg.setBackgroundColor('#ffffff');
    
    // –ü–æ–ª—É—á–∞–µ–º initData
    const initData = tg.initData;
    
    if (!initData) {
        error.value = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram';
        loading.value = false;
        return;
    }
    
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        const response = await axios.post('/telegram/webapp-auth', {
            initData: initData,
        });
        
        if (response.data.success) {
            // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞
            // Laravel —É—Å—Ç–∞–Ω–æ–≤–∏—Ç cookie —Å–µ—Å—Å–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            // –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É Mini App
            router.push('/tg-app/main');
        } else {
            error.value = response.data.error || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
        }
    } catch (err) {
        console.error('Telegram auth error:', err);
        error.value = err.response?.data?.error || '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
    } finally {
        loading.value = false;
    }
});
</script>
```

#### 5.3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram WebApp SDK

–í `laravel/resources/views/app.blade.php` –∏–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º layout –¥–ª—è Mini App:

```html
<!-- Telegram WebApp SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
```

---

### –≠—Ç–∞–ø 6: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º —Å–∞–π—Ç–æ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

#### 6.1. Telegram Login Widget –Ω–∞ —Å–∞–π—Ç–µ

–î–ª—è –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Telegram –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–∞–π—Ç–µ (–Ω–µ –≤ Mini App) –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **Telegram Login Widget**.

–î–æ–±–∞–≤–∏—Ç—å –≤ —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç:

```vue
<!-- laravel/resources/js/components/TelegramLoginWidget.vue -->
<template>
    <div class="telegram-login-widget">
        <script 
            async 
            src="https://telegram.org/js/telegram-widget.js?22" 
            data-telegram-login="{{ botName }}" 
            data-size="large" 
            data-onauth="onTelegramAuth"
            data-request-access="write"
        ></script>
    </div>
</template>

<script setup>
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –≤–∏–¥–∂–µ—Ç
window.onTelegramAuth = function(user) {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ backend
    axios.post('/telegram/widget-auth', {
        id: user.id,
        first_name: user.first_name,
        last_name: user.last_name,
        username: user.username,
        photo_url: user.photo_url,
        auth_date: user.auth_date,
        hash: user.hash,
    }).then(response => {
        if (response.data.success) {
            window.location.reload();
        }
    });
};
</script>
```

#### 6.2. Endpoint –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞

–í `TelegramAuthController` –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `widgetAuth()` (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ `webappAuth`, –Ω–æ —Å –¥—Ä—É–≥–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞).

---

### –≠—Ç–∞–ø 7: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### 7.1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ Telegram –≤ –ø—Ä–æ—Ñ–∏–ª—å

–í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è (`ProfileEdit.vue`) –¥–æ–±–∞–≤–∏—Ç—å:

```vue
<template>
    <!-- ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ... -->
    
    <div class="social-connections">
        <h3>–ü—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã</h3>
        
        <!-- Telegram -->
        <div class="connection-item">
            <span>Telegram</span>
            <span v-if="user.telegram_id">
                ‚úì –ü—Ä–∏–≤—è–∑–∞–Ω (@{{ user.telegram_username }})
                <button @click="detachTelegram">–û—Ç–≤—è–∑–∞—Ç—å</button>
            </span>
            <span v-else>
                –ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω
                <a :href="telegramBotUrl" target="_blank">–ü—Ä–∏–≤—è–∑–∞—Ç—å</a>
            </span>
        </div>
        
        <!-- VK, Yandex (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ) -->
    </div>
</template>

<script setup>
import { ref } from 'vue';
import axios from 'axios';

const user = ref(/* –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */);
const telegramBotUrl = `https://t.me/${config('services.telegram.bot_name')}?start=link`;

const detachTelegram = async () => {
    if (!confirm('–û—Ç–≤—è–∑–∞—Ç—å Telegram –∞–∫–∫–∞—É–Ω—Ç?')) return;
    
    try {
        await axios.post('/telegram/detach');
        // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user.value.telegram_id = null;
    } catch (err) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–≤—è–∑–∫–µ');
    }
};
</script>
```

---

### –≠—Ç–∞–ø 8: Webhook –¥–ª—è –±–æ—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

#### 8.1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞

–°–æ–∑–¥–∞—Ç—å: `laravel/app/Modules/Telegram/src/Http/Controllers/TelegramWebhookController.php`

```php
<?php

namespace Telegram\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

class TelegramWebhookController extends Controller
{
    public function handle(Request $request)
    {
        $update = $request->all();
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
        if (isset($update['message']['text']) && str_starts_with($update['message']['text'], '/start')) {
            $chatId = $update['message']['chat']['id'];
            $startParam = explode(' ', $update['message']['text'])[1] ?? null;
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π "–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
            $this->sendMessage($chatId, '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ PrimeFoods!', [
                'inline_keyboard' => [[
                    [
                        'text' => '–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ',
                        'web_app' => ['url' => config('services.telegram.webapp_url')],
                    ],
                ]],
            ]);
        }
        
        return response()->json(['ok' => true]);
    }
    
    private function sendMessage($chatId, $text, $replyMarkup = null)
    {
        // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Telegram Bot API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        // –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É —Ç–∏–ø–∞ telegram-bot-sdk
    }
}
```

#### 8.2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook

–í `@BotFather` –≤—ã–ø–æ–ª–Ω–∏—Ç—å:
```
/setwebhook
URL: https://primefoods.ru/api/telegram/webhook
```

---

### –≠—Ç–∞–ø 9: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ActivityLogService

–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É –¥–ª—è Telegram –≤ `UserActivityLog`:

```php
const PROVIDER_TELEGRAM = 'telegram';
```

---

### –≠—Ç–∞–ø 10: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### 10.1. –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:** Telegram Bot **–ù–ï –ø—Ä–∏–Ω–∏–º–∞–µ—Ç** `localhost` URLs. –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** –Ω—É–∂–µ–Ω –ø—É–±–ª–∏—á–Ω—ã–π HTTPS —Ç—É–Ω–Ω–µ–ª—å.

**–í–∞—Ä–∏–∞–Ω—Ç 1: ngrok**

1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:**
   - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ https://dashboard.ngrok.com/signup (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
   - –ü–æ–ª—É—á–∏—Ç–µ authtoken: https://dashboard.ngrok.com/get-started/your-authtoken
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ authtoken:
     ```bash
     ngrok config add-authtoken –≤–∞—à_authtoken_–∑–¥–µ—Å—å
     ```

2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ngrok: https://ngrok.com/download
   ```bash
   # macOS
   brew install ngrok
   ```

3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç—É–Ω–Ω–µ–ª—å –Ω–∞ –ø–æ—Ä—Ç –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
   ```bash
   ngrok http 8116
   ```

4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π HTTPS URL (–Ω–∞–ø—Ä–∏–º–µ—Ä: `https://abc123.ngrok-free.app`)

5. –î–æ–±–∞–≤—å—Ç–µ –≤ `laravel/.env`:
   ```env
   TELEGRAM_WEBAPP_URL_DEV=https://abc123.ngrok-free.app/tg-app
   ```

6. –í @BotFather –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ Menu Button —Å —ç—Ç–∏–º URL

7. **–í–∞–∂–Ω–æ:** –ü—Ä–∏ –∫–∞–∂–¥–æ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ ngrok URL –º–µ–Ω—è–µ—Ç—Å—è (–Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º –ø–ª–∞–Ω–µ). –î–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
   - ngrok —Å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∞–∫–∫–∞—É–Ω—Ç–æ–º –∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º –¥–æ–º–µ–Ω–æ–º (–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω)
   - –ò–ª–∏ Cloudflare Tunnel (—Å–º. –Ω–∏–∂–µ) ‚Äî –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

**–í–∞—Ä–∏–∞–Ω—Ç 2: Cloudflare Tunnel (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)**

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:** –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π, —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –¥–æ–º–µ–Ω

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `cloudflared`:
   ```bash
   # macOS
   brew install cloudflared
   
   # –ò–ª–∏ —Å–∫–∞—á–∞–π—Ç–µ —Å https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/
   ```

2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç—É–Ω–Ω–µ–ª—å:
   ```bash
   cloudflared tunnel --url http://localhost:8116
   ```

3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π HTTPS URL (–Ω–∞–ø—Ä–∏–º–µ—Ä: `https://abc123.trycloudflare.com`)

4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π URL –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ ngrok –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –≤—ã—à–µ

**–í–∞—Ä–∏–∞–Ω—Ç 3: –õ–æ–∫–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω —Å —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)**

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω —Å HTTPS, –Ω–æ —ç—Ç–æ —Å–ª–æ–∂–Ω–µ–µ –∏ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ DNS –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤. –î–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤ ngrok ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä.

#### 10.2. –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. ‚úÖ –û—Ç–∫—Ä—ã—Ç–∏–µ Mini App ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
2. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ Telegram
3. ‚úÖ –í—Ö–æ–¥ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ telegram_id
4. ‚úÖ –ü—Ä–∏–≤—è–∑–∫–∞ Telegram –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –∞–∫–∫–∞—É–Ω—Ç—É (–µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω)
5. ‚úÖ –û—Ç–≤—è–∑–∫–∞ Telegram –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
6. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
7. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–Ω–µ–≤–µ—Ä–Ω–∞—è –ø–æ–¥–ø–∏—Å—å, –∏—Å—Ç—ë–∫—à–∏–π auth_date)

---

### –≠—Ç–∞–ø 11: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–û–±–Ω–æ–≤–∏—Ç—å:
- `docs/LOCAL_SETUP.md` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é –ø—Ä–æ Telegram Bot Token
- –°–æ–∑–¥–∞—Ç—å `docs/TELEGRAM_MINI_APP.md` ‚Äî –¥–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ:

1. **–í–°–ï–ì–î–ê –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–¥–ø–∏—Å—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ** ‚Äî –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–æ–≤–µ—Ä—è—Ç—å –∫–ª–∏–µ–Ω—Ç—É
2. **–ü—Ä–æ–≤–µ—Ä—è—Ç—å auth_date** ‚Äî –æ—Ç–∫–ª–æ–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤
3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å timing-safe —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ** (`hash_equals`)
4. **–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏** (—É—Å–ø–µ—à–Ω—ã–µ –∏ –Ω–µ—É—Å–ø–µ—à–Ω—ã–µ)
5. **–•—Ä–∞–Ω–∏—Ç—å Bot Token –≤ `.env`** ‚Äî –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π

---

## üìù –ß–µ–∫–ª–∏—Å—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [ ] –°–æ–∑–¥–∞–Ω –±–æ—Ç –≤ @BotFather
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –ø–æ–ª–µ–π Telegram
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å User
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω TelegramAuthService
- [ ] –°–æ–∑–¥–∞–Ω TelegramAuthController
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã —Ä–æ—É—Ç—ã
- [ ] –°–æ–∑–¥–∞–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç TelegramApp.vue
- [ ] –ü–æ–¥–∫–ª—é—á–µ–Ω Telegram WebApp SDK
- [ ] –û–±–Ω–æ–≤–ª—ë–Ω –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø—Ä–∏–≤—è–∑–∫–∞/–æ—Ç–≤—è–∑–∫–∞)
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ ActivityLogService
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω webhook (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑–æ–≤–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

1. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞** ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∑–∞–∫–∞–∑–∞—Ö
2. **–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è** ‚Äî –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ—Ä–∑–∏–Ω–æ–π** ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ—Ä–∑–∏–Ω—ã –º–µ–∂–¥—É —Å–∞–π—Ç–æ–º –∏ Mini App
4. **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è** ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö Telegram –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è UX
